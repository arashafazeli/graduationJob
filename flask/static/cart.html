<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Webstore - Cart</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="static/js/script.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link href="static/css/style.css" type="text/css" rel="stylesheet">
  </head>
  <body onload="showCart(); cartLength();">
    <nav class="navbar navbar-dark navbar-expand bg-dark px-5">
      <!-- Links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="navbar-brand" style="cursor:pointer" href="/">Webshop</a>
        </li>
      </ul>
      <div class="form-inline px-4" style="width: 45%; opacity: 0; pointer-events: none">
        <input style="border-left: 2px solid white" type="text" class="form-control" placeholder="Search after products..." oninput="search(this.value)" onclick="search(this.value)" id="inpSearch">
      </div>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" href="/cart" id="lblCart">Cart</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin">Admin</a>
        </li>
      </ul>
    </nav>

    <div class="wrapper" style="margin-left: 9em">
      <h2 style="margin-top: 1em; margin-bottom: 1.5em">My cart</h2>
      <div id="tblwrapper" style="border-left: 2px solid grey">
        <table id="tblCart" style="margin-bottom: 2em">
        </table>
      </div>
    </div>


    <script>
      let cart = [];

      function showCart() {
	    cart = parseCookie('cart');

	    $("#lblCart").html(`Cart (${cart.length})`);

	    $("#tblCart").html("");

	    for (let i = 0; i < cart.length; i++) {
		  $.get("/api/product/get/"+cart[i].productID, {}, function(data) {
		      let product = parseJSON(data[0]);
		      console.log(product);
		      var fullPrice =  cart[i].antall*product.price;

		      $("#tblCart").append(`
                      <tr> <div style="width: 4em; height: 1px; background-color: black"></div> </tr>
		              <tr>
		              <td><button style="margin-left: 2em" onclick="deleteItem(${product.id})" class="btn-close"></button></td>
                      <td><img style="width: 9em; height: 9em; margin-left: 1em" src='/static/media/${product.img}'></td>

                      <td style="text-align: center" ><p style="width: 9em; font-size:1.4em; margin-left: 2em; margin-bottom: 0">${product.name}</p></td>
                      <td><button class="btn btn-primary" style="margin-left: 1.5em; margin-right: .5em" onclick="editCart(${cart[i].productID}, false)">-</button> ${cart[i].antall} 
                      <button class="btn btn-primary" style="margin-left: .5em" onclick="editCart(${cart[i].productID}, true)">+</button></td>
                      <td><p style="font-size: 1.4em; margin-left: 2em; margin-bottom: 0">${product.price} kr</p></td>
                      <td><p style="font-size: 1.4em; margin-left: 2em; margin-bottom: 0">${fullPrice} kr</p> </td>
                      </tr>

              `);
		  });
	    }
      }
      function deleteItem(productID) {
        for (var i = 0; i < cart.length; i++) {
          if (cart[i].productID === productID) {
            cart.splice(i, 1);
          }
        }

        var json_str = JSON.stringify(cart);
        createCookie('cart', json_str);

        showCart();
      }
      
      function editCart(productID, increment) {
        for (var i = 0; i < cart.length; i++) {
          if (cart[i].productID === productID) {
            if (increment) {
              cart[i].antall = cart[i].antall + 1;
            } else {
              if (cart[i].antall === 1) {
                cart.splice(i, 1);
              } else {
                cart[i].antall = cart[i].antall - 1;
              }
            }
          }
      }

  var json_str = JSON.stringify(cart);
  createCookie('cart', json_str);

  showCart();
}
    </script>
  </body>
</html>
